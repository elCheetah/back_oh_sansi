generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * Enums
 * =========================
 */

enum EstadoFase {
  PENDIENTE
  EN_EJECUCION
  FINALIZADA
  CANCELADA
}

enum TipoFase {
  CLASIFICATORIA
  FINAL
}

enum TipoDocumento {
  CI
  PASAPORTE
  CARNET_EXTRANJERO
  CERTIFICADO_NACIMIENTO
}

enum Sexo {
  MASCULINO
  FEMENINO
  OTRO
}

enum Rol {
  ADMINISTRADOR
  EVALUADOR
  RESPONSABLE
}

enum RolEquipo {
  LIDER
  PARTICIPANTE
}

enum EstadoParticipacion {
  CLASIFICADO
  NO_CLASIFICADO
  DESCALIFICADO
}

enum ModalidadCategoria {
  INDIVIDUAL
  GRUPAL
}

/**
 * =========================
 * Catálogos base
 * =========================
 */

model Areas {
  id          Int     @id @default(autoincrement())
  codigo      String? @db.VarChar(50)
  nombre      String  @db.VarChar(100)
  descripcion String? @db.Text
  estado      Boolean @default(true)

  categorias Categorias[]

  @@unique([nombre])
  @@unique([codigo])
  @@map("areas")
}

model Niveles {
  id          Int     @id @default(autoincrement())
  codigo      String? @db.VarChar(50)
  nombre      String  @db.VarChar(100)
  descripcion String? @db.Text
  estado      Boolean @default(true)

  categorias Categorias[]

  @@unique([nombre])
  @@unique([codigo])
  @@map("niveles")
}

/**
 * =========================
 * Categorías
 * =========================
 */

model Categorias {
  id      Int @id @default(autoincrement())
  gestion Int

  area_id   Int
  nivel_id  Int
  modalidad ModalidadCategoria
  estado    Boolean            @default(true)

  nota_min_clasificacion Int @default(51)

  // Medallero fase final
  oros_final      Int @default(1)
  platas_final    Int @default(1)
  bronces_final   Int @default(1)
  menciones_final Int @default(0)

  creado_en DateTime @default(now())

  area  Areas   @relation(fields: [area_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  nivel Niveles @relation(fields: [nivel_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  participaciones Participacion[]
  asignaciones    Asignaciones[]

  @@unique([gestion, area_id, nivel_id, modalidad])
  @@index([gestion])
  @@index([area_id])
  @@index([nivel_id])
  @@map("categorias")
}

/**
 * =========================
 * Usuarios y seguridad
 * =========================
 */

model Usuarios {
  id               Int           @id @default(autoincrement())
  contrasena_hash  String        @db.VarChar(255)
  nombre           String        @db.VarChar(100)
  primer_apellido  String        @db.VarChar(100)
  segundo_apellido String?       @db.VarChar(100)
  tipo_documento   TipoDocumento
  numero_documento String        @db.VarChar(20)
  correo           String        @unique @db.VarChar(150)
  telefono         String?       @db.VarChar(20)
  cargo            String?       @db.VarChar(100)
  profesion        String?       @db.VarChar(100)
  institucion      String?       @db.VarChar(150)
  estado           Boolean       @default(true)
  creado_en        DateTime      @default(now())
  actualizado_en   DateTime?
  rol              Rol           @default(EVALUADOR)

  evaluaciones Evaluaciones[]
  logs         Logs[]
  reportes     Reportes[]
  asignaciones Asignaciones[]

  @@unique([tipo_documento, numero_documento])
  @@map("usuarios")
}

/**
 * =========================
 * Fases (clasificatoria / final)
 * =========================
 */

model Fases {
  id          Int        @id @default(autoincrement())
  nombre      String     @db.VarChar(100)
  descripcion String?    @db.Text
  inicio      DateTime?
  fin         DateTime?
  estado      EstadoFase @default(PENDIENTE)
  creado_en   DateTime   @default(now())

  // Gestión como atributo numérico (ej: 2025)
  gestion Int

  tipo TipoFase @default(CLASIFICATORIA)

  // Flags para correo y publicación de resultados de ESA fase
  correos_enviados      Boolean @default(false) // p.ej. ya se enviaron mails de clasificación/final
  resultados_publicados Boolean @default(false) // visible en landing

  evaluaciones Evaluaciones[]

  @@unique([nombre, gestion])
  @@map("fases")
}

/**
 * =========================
 * Tutores / Olimpistas / Equipos
 * =========================
 */

model Tutores {
  id               Int           @id @default(autoincrement())
  nombre           String        @db.VarChar(100)
  primer_apellido  String        @db.VarChar(100)
  segundo_apellido String?       @db.VarChar(100)
  tipo_documento   TipoDocumento
  numero_documento String        @db.VarChar(20)
  telefono         String        @db.VarChar(20)
  correo           String        @db.VarChar(150)
  unidad_educativa String        @db.VarChar(150)
  profesion        String?       @db.VarChar(150)
  creado_en        DateTime      @default(now())

  olimpistas Olimpistas[]

  @@unique([tipo_documento, numero_documento])
  @@map("tutores")
}

model Olimpistas {
  id               Int           @id @default(autoincrement())
  nombre           String        @db.VarChar(100)
  primer_apellido  String        @db.VarChar(100)
  segundo_apellido String?       @db.VarChar(100)
  tipo_documento   TipoDocumento
  numero_documento String        @db.VarChar(20)
  unidad_educativa String        @db.VarChar(150)
  departamento     String        @db.VarChar(100)
  grado            String?       @db.VarChar(50)
  fecha_nacimiento DateTime?
  sexo             Sexo?
  estado           Boolean       @default(true)
  creado_en        DateTime      @default(now())
  correo           String        @unique @db.VarChar(150)
  tutor_id         Int?
  tutor            Tutores?      @relation(fields: [tutor_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  participacion   Participacion[]
  miembros_equipo MiembrosEquipo[]

  @@unique([tipo_documento, numero_documento])
  @@map("olimpistas")
}

model Equipos {
  id        Int      @id @default(autoincrement())
  nombre    String   @db.VarChar(100)
  creado_en DateTime @default(now())

  miembros      MiembrosEquipo[]
  participacion Participacion[]

  @@unique([nombre])
  @@map("equipos")
}

model MiembrosEquipo {
  id            Int       @id @default(autoincrement())
  olimpista_id  Int
  equipo_id     Int
  rol_en_equipo RolEquipo

  olimpista Olimpistas @relation(fields: [olimpista_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  equipo    Equipos    @relation(fields: [equipo_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([olimpista_id, equipo_id])
  @@index([olimpista_id])
  @@index([equipo_id])
  @@map("miembros_equipo")
}

/**
 * =========================
 * Participación y asignación a evaluadores
 * =========================
 */

model Participacion {
  id           Int                 @id @default(autoincrement())
  categoria_id Int
  olimpista_id Int?
  equipo_id    Int?
  estado       EstadoParticipacion @default(NO_CLASIFICADO)
  creado_en    DateTime            @default(now())

  categoria Categorias  @relation(fields: [categoria_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  olimpista Olimpistas? @relation(fields: [olimpista_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  equipo    Equipos?    @relation(fields: [equipo_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  evaluaciones Evaluaciones[]

  @@unique([olimpista_id, categoria_id])
  @@unique([equipo_id, categoria_id])
  @@index([categoria_id])
  @@index([olimpista_id])
  @@index([equipo_id])
  @@map("participacion")
}

model Asignaciones {
  id           Int      @id @default(autoincrement())
  usuario_id   Int
  categoria_id Int
  estado       Boolean  @default(true)
  creado_en    DateTime @default(now())

  usuario   Usuarios   @relation(fields: [usuario_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  categoria Categorias @relation(fields: [categoria_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([usuario_id, categoria_id])
  @@index([usuario_id])
  @@index([categoria_id])
  @@map("asignaciones")
}

/**
 * =========================
 * Evaluaciones
 * =========================
 */

model Evaluaciones {
  id                  Int       @id @default(autoincrement())
  participacion_id    Int
  evaluador_id        Int
  fase_id             Int
  nota                Decimal   @db.Decimal(5, 2)
  comentario          String?   @db.Text
  creado_en           DateTime  @default(now())
  validado            Boolean   @default(false) // Responsable la revisa
  ultima_modificacion DateTime?

  participacion Participacion @relation(fields: [participacion_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  evaluador     Usuarios      @relation(fields: [evaluador_id], references: [id], onDelete: Restrict, onUpdate: NoAction)
  fase          Fases         @relation(fields: [fase_id], references: [id], onDelete: Restrict, onUpdate: NoAction)

  @@unique([participacion_id, evaluador_id, fase_id])
  @@index([participacion_id])
  @@index([evaluador_id])
  @@index([fase_id])
  @@map("evaluaciones")
}

/**
 * =========================
 * Reportes y Logs
 * =========================
 */

model Reportes {
  id           Int      @id @default(autoincrement())
  tipo         String   @db.VarChar(100)
  titulo       String   @db.VarChar(150)
  parametros   Json?    @db.JsonB
  archivo      String?  @db.VarChar(255)
  generado_por Int
  generado_en  DateTime @default(now())

  generadoPor Usuarios? @relation(fields: [generado_por], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([generado_por])
  @@map("reportes")
}

model Logs {
  id             Int      @id @default(autoincrement())
  entidad        String   @db.VarChar(100)
  entidad_id     Int?
  campo          String?  @db.VarChar(100)
  valor_anterior String?  @db.Text
  valor_nuevo    String?  @db.Text
  usuario_id     Int
  fecha_cambio   DateTime @default(now())
  motivo         String?  @db.Text

  usuario Usuarios @relation(fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([usuario_id])
  @@map("logs")
}

/**
 * generator erd {
 * provider = "prisma-erd-generator"
 * }
 */
